openapi: 3.0.3
info:
  title: S3 Presigned URL Service
  version: 1.0.0
  description: |
    This API generates AWS S3 presigned URLs for uploading and downloading objects.
    Requests must be authenticated using HMAC headers.

    ⚠️ **Note**: `/generate-auth` is provided only for local testing/development.  
    In production, clients must generate their own authentication headers.
servers:
  - url: https://officebali.e1-vhp.com:33443
    description: Production server
  - url: http://localhost:8000
    description: Local dev server
paths:
  /:
    get:
      summary: Health check
      description: Verify that the service is running.
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              example:
                message: "System is live and running"
  /presigned-url:
    post:
      summary: Generate presigned S3 URL
      description: |
        Generates a presigned URL for either uploading (`put_object`) or downloading (`get_object`) files.
        
        **Authentication required** via custom headers:
        - `x-timestamp` (epoch seconds)
        - `x-s1gnature` (HMAC SHA256 signature)
        - `x-n0nce` (random nonce)
      security:
        - hmacAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file_name
              properties:
                file_name:
                  type: string
                  example: "video1.mp4"
                file_type:
                  type: string
                  example: "video/mp4"
                operation:
                  type: string
                  enum: [get_object, put_object]
                  default: get_object
            example:
              file_name: "video1.mp4"
              operation: "get_object"
      responses:
        "200":
          description: Presigned URL successfully generated
          content:
            application/json:
              example:
                presigned_url: "https://s3.ap-southeast-3.amazonaws.com/vhp-elearning-videos/video1.mp4?X-Amz-Algorithm=AWS4-HMAC-SHA256&..."
                file_name: "video1.mp4"
                file_type: null
                operation: "get_object"
                expires_in: "1 hour"
                message: "Get the data"
        "400":
          description: Invalid request (e.g. wrong operation)
        "401":
          description: Authentication failed
        "500":
          description: Server error (e.g. AWS credentials missing)
  /generate-auth:
    get:
      summary: Generate test authentication headers
      description: |
        Returns a set of authentication headers (`x-timestamp`, `x-n0nce`, `x-s1gnature`) 
        that can be used to call `/presigned-url`.

        ⚠️ **Important**: This endpoint is only for development/testing.  
        In production, clients must generate their own headers using the HMAC scheme.
      responses:
        "200":
          description: Headers successfully generated
          content:
            application/json:
              example:
                headers:
                  x-timestamp: "1759114544"
                  x-s1gnature: "b32fbbb693ecc87c21eba63d75eb830bdbdd5950c1023ed7bf82986023ad53ca"
                  x-n0nce: "aa762e8519d44dac129c78b6c87d5ab4"
components:
  securitySchemes:
    hmacAuth:
      type: apiKey
      in: header
      name: x-s1gnature
      description: |
        Custom HMAC-based authentication.
        Requires three headers:
        - `x-timestamp`: Epoch time in seconds
        - `x-n0nce`: Random nonce
        - `x-s1gnature`: HMAC-SHA256 of `timestamp|nonce|path`
